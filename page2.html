<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Archive Item Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: system-ui, monospace;
      background:#020617;
      color:#e5e7eb;
      padding:2rem;
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    h2 { margin-bottom:1rem; }
    #log {
      flex:1;
      background:#020617;
      border:1px solid #334155;
      padding:1rem;
      overflow-y:auto;
      white-space:pre-wrap;
      font-size:.9rem;
    }
  </style>
</head>
<body>

<h2>Collecting Archive Item Identifiers…</h2>
<div id="log"></div>

<script>
/* ------------------------------------------------ */
/* Utilities                                        */
/* ------------------------------------------------ */

const logBox = document.getElementById("log");

const log = msg => {
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
};

const sleep = ms => new Promise(r => setTimeout(r, ms));

const shuffle = arr => {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
};

/* ------------------------------------------------ */
/* Load metadata                                    */
/* ------------------------------------------------ */

const stored = sessionStorage.getItem("archive_metadata");
if (!stored) {
  alert("No metadata found. Start from page1.html");
  throw new Error("Missing metadata");
}

const metadata = JSON.parse(stored);
const profiles = metadata.data;

/* ------------------------------------------------ */
/* Extract usernames                                */
/* ------------------------------------------------ */

const extractUsername = url => {
  const m = url.match(/\/details\/@([^/]+)/);
  return m ? m[1] : null;
};

let usernames = profiles
  .map(p => extractUsername(p.archive_profile_url))
  .filter(Boolean);

/* ------------------------------------------------ */
/* Randomize ONCE (never repeated)                  */
/* ------------------------------------------------ */

shuffle(usernames);

log(`Profiles queued: ${usernames.length}`);

/* ------------------------------------------------ */
/* Fetch identifiers (1 request per user)           */
/* ------------------------------------------------ */

async function fetchIdentifiers(username) {
  const url =
    "https://archive.org/advancedsearch.php" +
    "?q=" + encodeURIComponent(`creator:"${username}"`) +
    "&fl[]=identifier" +
    "&rows=10000" +
    "&page=1" +
    "&output=json";

  const res = await fetch(url);
  const json = await res.json();
  return json.response?.docs || [];
}

/* ------------------------------------------------ */
/* Main Execution (2 requests / second)              */
/* ------------------------------------------------ */

(async () => {
  const collectedItems = [];

  for (let i = 0; i < usernames.length; i++) {
    const user = usernames[i];

    log(`\n[${i + 1}/${usernames.length}] Fetching → ${user}`);

    try {
      const items = await fetchIdentifiers(user);

      log(`✔ ${items.length} items`);

      for (const it of items) {
        collectedItems.push({
          identifier: it.identifier,
          owner: user
        });
      }

    } catch (e) {
      log(`✖ Failed: ${e.message}`);
    }

    /* ---- Rate limit: exactly 2 req / second ---- */
    await sleep(500);
  }

  shuffle(collectedItems);

  sessionStorage.setItem(
    "archive_items",
    JSON.stringify({
      total: collectedItems.length,
      items: collectedItems
    })
  );

  log(`\n✔ DONE`);
  log(`Total identifiers: ${collectedItems.length}`);
  log(`Redirecting to page3.html`);

  window.location.href = "page3.html";
})();
</script>

</body>
</html>
