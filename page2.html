<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Archive Item Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: system-ui, monospace;
      background: #020617;
      color: #e5e7eb;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    h2 {
      margin-bottom: 1rem;
    }

    #log {
      flex: 1;
      background: #020617;
      border: 1px solid #334155;
      padding: 1rem;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    #okBtn {
      align-self: center;
      padding: 0.7rem 2.5rem;
      font-size: 1rem;
      font-weight: 600;
      background: #22c55e;
      color: #020617;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

<h2>Collecting Archive Item Identifiers…</h2>
<div id="log"></div>
<button id="okBtn">OK</button>

<script>
/* ---------------------------------- */
/* Utilities                          */
/* ---------------------------------- */

const logBox = document.getElementById("log");
const okBtn = document.getElementById("okBtn");

const log = msg => {
  logBox.textContent += msg + "\n";
  logBox.scrollTop = logBox.scrollHeight;
};

const shuffleArray = arr => {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
};

/* ---------------------------------- */
/* Load metadata                      */
/* ---------------------------------- */

const stored = sessionStorage.getItem("archive_metadata");
if (!stored) {
  alert("No metadata found. Start from index.html");
  throw new Error("Missing metadata");
}

const metadata = JSON.parse(stored);
const profiles = metadata.data;

log(`Profiles found: ${profiles.length}`);

/* ---------------------------------- */
/* Extract usernames                  */
/* ---------------------------------- */

function extractUsername(url) {
  const match = url.match(/\/details\/@([^/]+)/);
  return match ? match[1] : null;
}

const usernames = profiles
  .map(p => extractUsername(p.archive_profile_url))
  .filter(Boolean);

log(`Valid accounts detected: ${usernames.length}`);
usernames.forEach(u => log("• " + u));

/* ---------------------------------- */
/* Archive Advanced Search (IDENTIFIER ONLY) */
/* ---------------------------------- */

async function fetchUserIdentifiers(username) {
  const query = `creator:"${username}"`;

  const url =
    "https://archive.org/advancedsearch.php" +
    "?q=" + encodeURIComponent(query) +
    "&fl[]=identifier" +
    "&rows=10000" +
    "&page=1" +
    "&output=json";

  log(`\nFetching identifiers for: ${username}`);

  const res = await fetch(url);
  const json = await res.json();

  return json.response?.docs || [];
}

/* ---------------------------------- */
/* Main execution                     */
/* ---------------------------------- */

(async () => {
  let collectedItems = [];

  for (const user of usernames) {
    try {
      const items = await fetchUserIdentifiers(user);

      log(`✔ ${items.length} identifiers found for ${user}`);

      items.forEach(item => {
        collectedItems.push({
          identifier: item.identifier,
          owner: user
        });

        // Display identifier
        log(`   • ${item.identifier}`);
      });

    } catch (err) {
      log(`✖ Failed for ${user}: ${err.message}`);
    }
  }

  log(`\nTotal identifiers collected: ${collectedItems.length}`);

  shuffleArray(collectedItems);

  // Store for page3
  sessionStorage.setItem(
    "archive_items",
    JSON.stringify({
      total: collectedItems.length,
      items: collectedItems
    })
  );

  log("\n✔ Data ready. Click OK to continue.");
  okBtn.style.display = "inline-block";
})();

okBtn.addEventListener("click", () => {
  window.location.href = "page3.html";
});
</script>

</body>
</html>
